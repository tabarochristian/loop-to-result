<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Experiment #{{ experiment.id }} - AI Lab</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background-color: #f8f9fa;
      }

      .experiment-container {
        padding: 0;
        min-height: 100vh;
      }

      .sidebar {
        padding: 0;
        background-color: #f8f9fa;
        border-right: 1px solid #dee2e6;
        height: 100vh;
        position: sticky;
        top: 0;
      }

      .main-content {
        padding: 2rem;
        background-color: white;
        min-height: 100vh;
      }

      .message {
        padding: 1rem;
        border-radius: 0.5rem;
        background-color: #f8f9fa;
      }

      .message-user {
        border-left: 4px solid #0d6efd;
      }

      .message-assistant {
        border-left: 4px solid #198754;
      }

      .message-system {
        border-left: 4px solid #6c757d;
      }

      .message-header {
        margin-bottom: 0.5rem;
      }

      .message-content pre {
        white-space: pre-wrap;
        word-wrap: break-word;
        margin: 0;
        font-family: "Consolas", "Monaco", "Courier New", monospace;
        background-color: #f8f9fa;
        padding: 0.5rem;
        border-radius: 0.25rem;
      }

      .conversation-body {
        max-height: 60vh;
        overflow-y: auto;
        padding: 1rem;
      }

      /* Syntax highlighting */
      .hljs {
        background-color: #f8f9fa !important;
        padding: 1rem !important;
        border-radius: 0.25rem;
      }

      /* Responsive adjustments */
      @media (max-width: 768px) {
        .sidebar {
          height: auto;
          position: relative;
        }

        .main-content {
          padding: 1rem;
        }

        .conversation-body {
          max-height: 50vh;
        }
      }
    </style>
  </head>
  <body>
    <div class="container-fluid experiment-container">
      <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3 sidebar">
          <div class="d-flex flex-column flex-shrink-0 p-3 bg-light h-100">
            <a
              href="/"
              class="d-flex align-items-center mb-3 link-dark text-decoration-none"
            >
              <span class="fs-4">AI Lab</span>
            </a>
            <hr />
            <ul class="nav nav-pills flex-column mb-auto">
              <li class="nav-item">
                <a href="/" class="nav-link">
                  <i class="fas fa-home me-2"></i>Dashboard
                </a>
              </li>
            </ul>
            <hr />
            <div class="experiment-info">
              <h5>Experiment Details</h5>
              <ul class="list-unstyled">
                <li><strong>ID:</strong> {{ experiment.id }}</li>
                <li>
                  <strong>Status:</strong>
                  <span
                    class="badge bg-{{ 'success' if experiment.status == 'success' else 'danger' if experiment.status in ['failed', 'stopped'] else 'primary' }}"
                  >
                    {{ experiment.status }}
                  </span>
                </li>
                <li><strong>Model:</strong> {{ experiment.model }}</li>
                <li><strong>Started:</strong> {{ experiment.created_at }}</li>
              </ul>
              <div class="actions mt-3">
                {% if experiment.status == 'running' %}
                <form
                  action="/experiment/{{ experiment.id }}/stop"
                  method="post"
                >
                  <button
                    type="submit"
                    class="btn btn-warning btn-sm w-100 mb-2"
                  >
                    <i class="fas fa-stop-circle me-1"></i> Stop
                  </button>
                </form>
                {% endif %}
                <form
                  action="/experiment/{{ experiment.id }}/delete"
                  method="post"
                >
                  <button type="submit" class="btn btn-danger btn-sm w-100">
                    <i class="fas fa-trash-alt me-1"></i> Delete
                  </button>
                </form>
              </div>
            </div>
          </div>
        </div>

        <!-- Main Content -->
        <div class="col-md-9 main-content">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>Experiment #{{ experiment.id }}</h2>
            <div>
              <span
                class="badge bg-{{ 'success' if experiment.status == 'success' else 'danger' if experiment.status in ['failed', 'stopped'] else 'primary' }}"
              >
                {{ experiment.status }}
              </span>
            </div>
          </div>

          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0">Initial Prompt</h5>
            </div>
            <div class="card-body">
              <p>{{ experiment.prompt }}</p>
            </div>
          </div>

          <!-- Conversation -->
          <div class="card mb-4">
            <div
              class="card-header d-flex justify-content-between align-items-center"
            >
              <h5 class="mb-0">Conversation</h5>
              <small class="text-muted" id="last-updated">Live</small>
            </div>
            <div class="card-body conversation-body" id="conversation">
              {% for message in messages %}
              <div class="message mb-3 message-{{ message.sender }}">
                <div class="message-header d-flex justify-content-between">
                  <strong class="sender">{{ message.sender }}</strong>
                  <small class="text-muted timestamp"
                    >{{ message.timestamp }}</small
                  >
                </div>
                <div class="message-content mt-1">
                  {% if message.sender == 'assistant' and '```python' in
                  message.content %}
                  <pre><code class="language-python">{{ message.content }}</code></pre>
                  {% else %}
                  <pre>{{ message.content }}</pre>
                  {% endif %}
                </div>
              </div>
              {% endfor %}
            </div>
          </div>

          <!-- User Input -->
          {% if experiment.status == 'running' %}
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">Add Input</h5>
            </div>
            <div class="card-body">
              <form
                id="message-form"
                action="/experiment/{{ experiment.id }}/message"
                method="post"
              >
                <div class="mb-3">
                  <textarea
                    class="form-control"
                    id="user-message"
                    name="message"
                    rows="3"
                    required
                  ></textarea>
                </div>
                <button type="submit" class="btn btn-primary">
                  <i class="fas fa-paper-plane me-1"></i> Send
                </button>
              </form>
            </div>
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/lib/core.min.js"></script>
    <script>
      // WebSocket connection for real-time updates
      const experimentId = "{{ experiment.id }}";
      const wsProtocol =
        window.location.protocol === "https:" ? "wss://" : "ws://";
      const wsUrl = wsProtocol + window.location.host + "/ws/" + experimentId;
      const socket = new WebSocket(wsUrl);

      socket.onmessage = function (event) {
        const data = JSON.parse(event.data);

        if (data.type === "new_message") {
          addMessageToConversation(data.sender, data.content, data.timestamp);
        } else if (data.type === "status_update") {
          updateExperimentStatus(data.status);
        }

        // Update last updated time
        document.getElementById("last-updated").textContent = "Live";
      };

      function addMessageToConversation(sender, content, timestamp) {
        const conversation = document.getElementById("conversation");
        const messageDiv = document.createElement("div");
        messageDiv.className = `message mb-3 message-${sender}`;

        messageDiv.innerHTML = `
                <div class="message-header d-flex justify-content-between">
                    <strong class="sender">${sender}</strong>
                    <small class="text-muted timestamp">${new Date(
                      timestamp
                    ).toLocaleString()}</small>
                </div>
                <div class="message-content mt-1">
                    <pre>${content}</pre>
                </div>
            `;

        conversation.appendChild(messageDiv);
        conversation.scrollTop = conversation.scrollHeight;
      }

      function updateExperimentStatus(newStatus) {
        const statusBadge = document.querySelector(
          ".badge.bg-primary, .badge.bg-success, .badge.bg-danger"
        );
        if (statusBadge) {
          // Update class
          statusBadge.className = `badge bg-${
            newStatus === "success"
              ? "success"
              : ["failed", "stopped"].includes(newStatus)
              ? "danger"
              : "primary"
          }`;
          // Update text
          statusBadge.textContent = newStatus;

          // Remove message form if experiment is no longer running
          if (newStatus !== "running") {
            const form = document.getElementById("message-form");
            if (form) form.parentNode.removeChild(form);
          }
        }
      }

      // Auto-scroll conversation to bottom
      document.addEventListener("DOMContentLoaded", function () {
        const conversation = document.getElementById("conversation");
        if (conversation) {
          conversation.scrollTop = conversation.scrollHeight;
        }

        // Apply syntax highlighting
        document.querySelectorAll("pre code").forEach((block) => {
          hljs.highlightElement(block);
        });
      });
    </script>
  </body>
</html>
